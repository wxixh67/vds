<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>GitHub Pages 图片管理器（原图版）</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body {
      font-family: system-ui, Segoe UI, Roboto;
      padding: 1rem;
      max-width: 1100px;
      margin: auto;
      background: #f9f9f9;
    }
    header {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1rem;
    }
    h1 {
      font-size: 1.5rem;
    }

    /* 使用 flex 布局，保持原图比例 */
    .grid {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }
    .card {
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid #eee;
      background: #fff;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
      transition: transform 0.15s ease;
      flex: 0 0 auto;
      max-width: 280px;   /* 限制单卡片最大宽度 */
    }
    .card:hover {
      transform: scale(1.03);
    }
    .card img {
      width: auto;        
      height: auto;
      max-width: 100%;    
      display: block;
    }
    .meta {
      padding: .5rem;
      font-size: .85rem;
      word-break: break-all;
      text-align: center;
      color: #333;
    }
    #status {
      margin: .5rem 0 1rem;
      font-size: .9rem;
      color: #555;
    }
    #loading {
      text-align: center;
      padding: 1rem;
      color: #888;
      display: none;
    }
  </style>
</head>
<body>
  <header>
    <h1>图片库</h1>
    <div style="margin-left:auto">仓库: <b>wxixh67/vds</b> · 路径: <b>p/</b></div>
  </header>

  <div id="status">载入中...</div>
  <div id="grid" class="grid"></div>
  <div id="loading">加载更多...</div>

<script>
const OWNER_REPO = "wxixh67/vds";
const PATH = "p/p";   // 修正目录路径
const PAGE_SIZE = 20;

let allItems = [];
let currentPage = 0;
let loading = false;

async function listImages(ownerRepo, path = 'p') {
  const api = `https://api.github.com/repos/${ownerRepo}/contents/${path}`;
  const res = await fetch(api);
  if (!res.ok) throw new Error(await res.text());
  const items = await res.json();
  return items.filter(i => i.type === 'file' && /\.(jpe?g|png|gif|webp|svg)$/i.test(i.name));
}

function makeCard(item) {
  const raw = item.download_url;
  const el = document.createElement('div');
  el.className = 'card';
  el.innerHTML = `
    <a href="${raw}" target="_blank" rel="noopener">
      <img alt="${item.name}" src="${raw}">
    </a>
    <div class="meta">${item.name}</div>
  `;
  return el;
}

function loadNextPage() {
  if (loading) return;
  loading = true;

  const grid = document.getElementById('grid');
  const loadingEl = document.getElementById('loading');

  const start = currentPage * PAGE_SIZE;
  const end = start + PAGE_SIZE;
  const items = allItems.slice(start, end);

  if (!items.length) {
    loadingEl.textContent = "✅ 已全部加载完成";  // ✅ 改进提示
    return;
  }

  for (const it of items) {
    grid.appendChild(makeCard(it));
  }

  currentPage++;
  loading = false;

  if (end >= allItems.length) {
    loadingEl.textContent = "✅ 已全部加载完成";  // ✅ 改进提示
  } else {
    loadingEl.style.display = "block";
    loadingEl.textContent = "加载更多...";
  }
}

(async () => {
  const status = document.getElementById('status');
  const loadingEl = document.getElementById('loading');
  try {
    allItems = await listImages(OWNER_REPO, PATH);
    if (!allItems.length) {
      status.textContent = '⚠️ p/ 目录下没有图片或目录不存在。';
    } else {
      status.textContent = `✅ 找到 ${allItems.length} 张图片。`;
      loadNextPage();
    }
  } catch (e) {
    status.textContent = '❌ 错误：' + e.message;
  }
})();

// 无限滚动监听
window.addEventListener('scroll', () => {
  if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 200) {
    loadNextPage();
  }
});
</script>
</body>
</html>
